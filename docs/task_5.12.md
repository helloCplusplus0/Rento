# T5.12 é”™è¯¯å¤„ç†å’Œç›‘æ§ä¼˜åŒ– - è®¾è®¡æ–¹æ¡ˆ

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡ç¼–å·**: T5.12  
**ä»»åŠ¡åç§°**: é”™è¯¯å¤„ç†å’Œç›‘æ§ä¼˜åŒ–  
**é¢„è®¡æ—¶é—´**: 4å°æ—¶  
**ä¼˜å…ˆçº§**: é«˜  
**çŠ¶æ€**: ğŸ”„ è¿›è¡Œä¸­

### å­ä»»åŠ¡æ¸…å•
- [ ] å¢å¼ºè´¦å•ç”Ÿæˆè¿‡ç¨‹çš„é”™è¯¯æ—¥å¿—è®°å½•
- [ ] å®ç°è´¦å•ç”Ÿæˆå¤±è´¥çš„æ™ºèƒ½å›é€€æœºåˆ¶
- [ ] æ·»åŠ è´¦å•ç³»ç»Ÿå¥åº·çŠ¶æ€ç›‘æ§
- [ ] å®Œå–„ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤ºå’Œåé¦ˆ
- [ ] å®ç°è´¦å•ç”Ÿæˆå¼‚å¸¸çš„è‡ªåŠ¨å‘Šè­¦

## ğŸ¯ è®¾è®¡ç›®æ ‡

åŸºäº T5.8-T5.11 å·²å®Œæˆçš„è´¦å•ç³»ç»Ÿä¼˜åŒ–åŸºç¡€ï¼Œå®ç°å®Œæ•´çš„é”™è¯¯å¤„ç†å’Œç›‘æ§ä¼˜åŒ–ï¼š

1. **é”™è¯¯å¯è§‚æµ‹æ€§**: æä¾›è¯¦ç»†çš„é”™è¯¯æ—¥å¿—è®°å½•å’Œè¿½è¸ªæœºåˆ¶
2. **æ™ºèƒ½å›é€€**: å®ç°å¤šå±‚æ¬¡çš„é”™è¯¯æ¢å¤å’Œå›é€€ç­–ç•¥
3. **å¥åº·ç›‘æ§**: å»ºç«‹ç³»ç»Ÿå¥åº·çŠ¶æ€ç›‘æ§å’Œé¢„è­¦æœºåˆ¶
4. **ç”¨æˆ·ä½“éªŒ**: æä¾›å‹å¥½çš„é”™è¯¯æç¤ºå’Œæ“ä½œæŒ‡å¯¼
5. **è‡ªåŠ¨å‘Šè­¦**: å®ç°å…³é”®é”™è¯¯çš„è‡ªåŠ¨æ£€æµ‹å’Œé€šçŸ¥

## ğŸ—ï¸ æŠ€æœ¯æ–¹æ¡ˆ

### 1. ç°çŠ¶åˆ†æ

#### 1.1 å·²æœ‰åŸºç¡€è®¾æ–½ âœ…
åŸºäºç°æœ‰çš„ç³»ç»Ÿï¼Œå·²å…·å¤‡ï¼š
- **äº‹åŠ¡ç®¡ç†**: T5.11 å®ç°çš„ TransactionManager å’Œæ•°æ®ä¸€è‡´æ€§ä¿æŠ¤
- **æ•°æ®ä¿®å¤**: T5.9-T5.10 å®ç°çš„æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤å·¥å…·
- **çŠ¶æ€åŒæ­¥**: å®Œæ•´çš„æŠ„è¡¨çŠ¶æ€åŒæ­¥æœºåˆ¶
- **é”™è¯¯å¤„ç†**: åŸºç¡€çš„ try-catch é”™è¯¯å¤„ç†
- **æ—¥å¿—è®°å½•**: console.log åŸºç¡€æ—¥å¿—è¾“å‡º

#### 1.2 éœ€è¦ä¼˜åŒ–çš„é—®é¢˜
- **æ—¥å¿—åˆ†æ•£**: é”™è¯¯æ—¥å¿—åˆ†æ•£åœ¨å„ä¸ªæ¨¡å—ï¼Œç¼ºä¹ç»Ÿä¸€ç®¡ç†
- **é”™è¯¯åˆ†ç±»**: ç¼ºä¹é”™è¯¯ç±»å‹åˆ†ç±»å’Œä¸¥é‡ç¨‹åº¦åˆ’åˆ†
- **å›é€€æœºåˆ¶**: é”™è¯¯å›é€€ç­–ç•¥ä¸å¤Ÿæ™ºèƒ½å’Œå®Œå–„
- **ç›‘æ§ç¼ºå¤±**: ç¼ºä¹ç³»ç»Ÿå¥åº·çŠ¶æ€çš„å®æ—¶ç›‘æ§
- **ç”¨æˆ·åé¦ˆ**: é”™è¯¯æç¤ºä¸å¤Ÿå‹å¥½ï¼Œç¼ºä¹æ“ä½œæŒ‡å¯¼

### 2. ç³»ç»Ÿæ¶æ„è®¾è®¡

#### 2.1 é”™è¯¯å¤„ç†æ¶æ„
```
ErrorHandlingSystem (é”™è¯¯å¤„ç†ç³»ç»Ÿ)
â”œâ”€â”€ ErrorLogger (é”™è¯¯æ—¥å¿—è®°å½•å™¨)
â”‚   â”œâ”€â”€ StructuredLogger (ç»“æ„åŒ–æ—¥å¿—)
â”‚   â”œâ”€â”€ ErrorClassifier (é”™è¯¯åˆ†ç±»å™¨)
â”‚   â””â”€â”€ LogAggregator (æ—¥å¿—èšåˆå™¨)
â”œâ”€â”€ FallbackManager (å›é€€ç®¡ç†å™¨)
â”‚   â”œâ”€â”€ RetryStrategy (é‡è¯•ç­–ç•¥)
â”‚   â”œâ”€â”€ FallbackChain (å›é€€é“¾)
â”‚   â””â”€â”€ RecoveryHandler (æ¢å¤å¤„ç†å™¨)
â”œâ”€â”€ HealthMonitor (å¥åº·ç›‘æ§å™¨)
â”‚   â”œâ”€â”€ SystemHealthChecker (ç³»ç»Ÿå¥åº·æ£€æŸ¥)
â”‚   â”œâ”€â”€ MetricsCollector (æŒ‡æ ‡æ”¶é›†å™¨)
â”‚   â””â”€â”€ AlertManager (å‘Šè­¦ç®¡ç†å™¨)
â””â”€â”€ UserFeedback (ç”¨æˆ·åé¦ˆ)
    â”œâ”€â”€ ErrorMessageFormatter (é”™è¯¯æ¶ˆæ¯æ ¼å¼åŒ–)
    â”œâ”€â”€ ActionSuggester (æ“ä½œå»ºè®®å™¨)
    â””â”€â”€ NotificationManager (é€šçŸ¥ç®¡ç†å™¨)
```

#### 2.2 ç›‘æ§æ¶æ„
```
MonitoringSystem (ç›‘æ§ç³»ç»Ÿ)
â”œâ”€â”€ HealthEndpoints (å¥åº·æ£€æŸ¥ç«¯ç‚¹)
â”‚   â”œâ”€â”€ /api/health/system (ç³»ç»Ÿå¥åº·)
â”‚   â”œâ”€â”€ /api/health/database (æ•°æ®åº“å¥åº·)
â”‚   â””â”€â”€ /api/health/bills (è´¦å•ç³»ç»Ÿå¥åº·)
â”œâ”€â”€ MetricsAPI (æŒ‡æ ‡API)
â”‚   â”œâ”€â”€ /api/metrics/errors (é”™è¯¯ç»Ÿè®¡)
â”‚   â”œâ”€â”€ /api/metrics/performance (æ€§èƒ½æŒ‡æ ‡)
â”‚   â””â”€â”€ /api/metrics/bills (è´¦å•æŒ‡æ ‡)
â””â”€â”€ AlertingAPI (å‘Šè­¦API)
    â”œâ”€â”€ /api/alerts/configure (å‘Šè­¦é…ç½®)
    â”œâ”€â”€ /api/alerts/status (å‘Šè­¦çŠ¶æ€)
    â””â”€â”€ /api/alerts/history (å‘Šè­¦å†å²)
```

### 3. æ ¸å¿ƒåŠŸèƒ½è®¾è®¡

#### 3.1 ç»“æ„åŒ–é”™è¯¯æ—¥å¿—ç³»ç»Ÿ
```typescript
// é”™è¯¯ç±»å‹å®šä¹‰
export enum ErrorType {
  BILL_GENERATION = 'BILL_GENERATION',
  DATA_CONSISTENCY = 'DATA_CONSISTENCY',
  DATABASE_ERROR = 'DATABASE_ERROR',
  VALIDATION_ERROR = 'VALIDATION_ERROR',
  EXTERNAL_SERVICE = 'EXTERNAL_SERVICE',
  SYSTEM_ERROR = 'SYSTEM_ERROR'
}

export enum ErrorSeverity {
  CRITICAL = 'CRITICAL',  // ç³»ç»Ÿæ— æ³•æ­£å¸¸å·¥ä½œ
  HIGH = 'HIGH',          // æ ¸å¿ƒåŠŸèƒ½å—å½±å“
  MEDIUM = 'MEDIUM',      // éƒ¨åˆ†åŠŸèƒ½å—å½±å“
  LOW = 'LOW'             // è½»å¾®å½±å“
}

// ç»“æ„åŒ–é”™è¯¯è®°å½•
export interface ErrorRecord {
  id: string
  timestamp: Date
  type: ErrorType
  severity: ErrorSeverity
  message: string
  context: {
    module: string
    function: string
    userId?: string
    contractId?: string
    billId?: string
    [key: string]: any
  }
  stack?: string
  metadata?: Record<string, any>
}
```

#### 3.2 æ™ºèƒ½å›é€€æœºåˆ¶
```typescript
// å›é€€ç­–ç•¥é…ç½®
export interface FallbackConfig {
  maxRetries: number
  retryDelay: number
  backoffMultiplier: number
  fallbackStrategies: FallbackStrategy[]
}

export interface FallbackStrategy {
  name: string
  condition: (error: Error) => boolean
  handler: (context: any) => Promise<any>
  priority: number
}

// è´¦å•ç”Ÿæˆå›é€€ç­–ç•¥
const billGenerationFallbacks: FallbackStrategy[] = [
  {
    name: 'retry_with_delay',
    condition: (error) => error.name === 'DatabaseTimeout',
    handler: async (context) => {
      await delay(context.retryDelay)
      return await context.originalFunction()
    },
    priority: 1
  },
  {
    name: 'single_bill_fallback',
    condition: (error) => error.message.includes('aggregation'),
    handler: async (context) => {
      return await generateSingleMeterBills(context.readingData)
    },
    priority: 2
  },
  {
    name: 'manual_intervention',
    condition: () => true, // æœ€åçš„å›é€€ç­–ç•¥
    handler: async (context) => {
      await logCriticalError(context.error, context)
      await notifyAdministrator(context)
      throw new Error('éœ€è¦æ‰‹åŠ¨å¹²é¢„')
    },
    priority: 999
  }
]
```

#### 3.3 ç³»ç»Ÿå¥åº·ç›‘æ§
```typescript
// å¥åº·æ£€æŸ¥é¡¹ç›®
export interface HealthCheck {
  name: string
  status: 'healthy' | 'degraded' | 'unhealthy'
  lastCheck: Date
  responseTime: number
  details?: Record<string, any>
  error?: string
}

// ç³»ç»Ÿå¥åº·çŠ¶æ€
export interface SystemHealth {
  overall: 'healthy' | 'degraded' | 'unhealthy'
  checks: HealthCheck[]
  uptime: number
  version: string
  timestamp: Date
}

// è´¦å•ç³»ç»Ÿç‰¹å®šå¥åº·æ£€æŸ¥
const billSystemHealthChecks = [
  'database_connection',
  'bill_generation_queue',
  'data_consistency',
  'recent_error_rate',
  'performance_metrics'
]
```

## ğŸ”§ è¯¦ç»†å®æ–½æ–¹æ¡ˆ

### æ­¥éª¤ 1: å®ç°ç»“æ„åŒ–é”™è¯¯æ—¥å¿—ç³»ç»Ÿ

#### 1.1 åˆ›å»ºé”™è¯¯æ—¥å¿—ç®¡ç†å™¨
```typescript
// src/lib/error-logger.ts
export class ErrorLogger {
  private static instance: ErrorLogger
  private errorStore: ErrorRecord[] = []
  
  static getInstance(): ErrorLogger {
    if (!ErrorLogger.instance) {
      ErrorLogger.instance = new ErrorLogger()
    }
    return ErrorLogger.instance
  }
  
  async logError(
    type: ErrorType,
    severity: ErrorSeverity,
    message: string,
    context: any,
    error?: Error
  ): Promise<void> {
    const errorRecord: ErrorRecord = {
      id: generateId(),
      timestamp: new Date(),
      type,
      severity,
      message,
      context,
      stack: error?.stack,
      metadata: this.extractMetadata(error)
    }
    
    // å­˜å‚¨åˆ°å†…å­˜ï¼ˆç”Ÿäº§ç¯å¢ƒå¯æ‰©å±•åˆ°æ•°æ®åº“ï¼‰
    this.errorStore.push(errorRecord)
    
    // æ§åˆ¶å°è¾“å‡ºï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    this.logToConsole(errorRecord)
    
    // å…³é”®é”™è¯¯ç«‹å³å‘Šè­¦
    if (severity === ErrorSeverity.CRITICAL) {
      await this.triggerAlert(errorRecord)
    }
  }
}
```

#### 1.2 å¢å¼ºè´¦å•ç”Ÿæˆé”™è¯¯è®°å½•
```typescript
// åœ¨ auto-bill-generator.ts ä¸­é›†æˆé”™è¯¯æ—¥å¿—
export async function generateBillsOnContractSigned(contractId: string) {
  const logger = ErrorLogger.getInstance()
  
  try {
    logger.logInfo('å¼€å§‹ç”ŸæˆåˆåŒè´¦å•', { contractId, module: 'auto-bill-generator' })
    
    // åŸæœ‰é€»è¾‘...
    
    logger.logInfo('åˆåŒè´¦å•ç”ŸæˆæˆåŠŸ', { contractId, billCount: bills.length })
    return bills
    
  } catch (error) {
    await logger.logError(
      ErrorType.BILL_GENERATION,
      ErrorSeverity.HIGH,
      `åˆåŒ ${contractId} è´¦å•ç”Ÿæˆå¤±è´¥: ${error.message}`,
      {
        module: 'auto-bill-generator',
        function: 'generateBillsOnContractSigned',
        contractId
      },
      error
    )
    
    // è§¦å‘å›é€€æœºåˆ¶
    return await fallbackManager.handleError(error, { contractId })
  }
}
```

### æ­¥éª¤ 2: å®ç°æ™ºèƒ½å›é€€æœºåˆ¶

#### 2.1 åˆ›å»ºå›é€€ç®¡ç†å™¨
```typescript
// src/lib/fallback-manager.ts
export class FallbackManager {
  private strategies: Map<ErrorType, FallbackStrategy[]> = new Map()
  
  registerStrategy(errorType: ErrorType, strategy: FallbackStrategy): void {
    if (!this.strategies.has(errorType)) {
      this.strategies.set(errorType, [])
    }
    this.strategies.get(errorType)!.push(strategy)
    this.strategies.get(errorType)!.sort((a, b) => a.priority - b.priority)
  }
  
  async handleError(error: Error, context: any): Promise<any> {
    const errorType = this.classifyError(error)
    const strategies = this.strategies.get(errorType) || []
    
    for (const strategy of strategies) {
      if (strategy.condition(error)) {
        try {
          const result = await strategy.handler({ ...context, error })
          
          // è®°å½•æˆåŠŸçš„å›é€€
          await ErrorLogger.getInstance().logInfo(
            `å›é€€ç­–ç•¥ ${strategy.name} æ‰§è¡ŒæˆåŠŸ`,
            { errorType, strategy: strategy.name, context }
          )
          
          return result
        } catch (fallbackError) {
          // è®°å½•å›é€€å¤±è´¥
          await ErrorLogger.getInstance().logError(
            ErrorType.SYSTEM_ERROR,
            ErrorSeverity.MEDIUM,
            `å›é€€ç­–ç•¥ ${strategy.name} æ‰§è¡Œå¤±è´¥`,
            { originalError: error.message, fallbackError: fallbackError.message },
            fallbackError
          )
        }
      }
    }
    
    // æ‰€æœ‰å›é€€ç­–ç•¥éƒ½å¤±è´¥
    throw new Error(`æ‰€æœ‰å›é€€ç­–ç•¥éƒ½å¤±è´¥: ${error.message}`)
  }
}
```

### æ­¥éª¤ 3: å®ç°ç³»ç»Ÿå¥åº·ç›‘æ§

#### 3.1 åˆ›å»ºå¥åº·æ£€æŸ¥API
```typescript
// src/app/api/health/system/route.ts
export async function GET() {
  const healthChecker = new SystemHealthChecker()
  
  try {
    const health = await healthChecker.checkSystemHealth()
    
    return Response.json(health, {
      status: health.overall === 'healthy' ? 200 : 503
    })
  } catch (error) {
    return Response.json(
      { error: 'Health check failed', details: error.message },
      { status: 500 }
    )
  }
}
```

#### 3.2 åˆ›å»ºè´¦å•ç³»ç»Ÿå¥åº·æ£€æŸ¥
```typescript
// src/lib/health-checker.ts
export class BillSystemHealthChecker {
  async checkBillSystemHealth(): Promise<HealthCheck> {
    const checks = await Promise.all([
      this.checkRecentBillGeneration(),
      this.checkDataConsistency(),
      this.checkErrorRate(),
      this.checkPerformance()
    ])
    
    const overallStatus = this.determineOverallStatus(checks)
    
    return {
      name: 'bill_system',
      status: overallStatus,
      lastCheck: new Date(),
      responseTime: Date.now() - startTime,
      details: {
        checks: checks.reduce((acc, check) => {
          acc[check.name] = check
          return acc
        }, {})
      }
    }
  }
  
  private async checkRecentBillGeneration(): Promise<HealthCheck> {
    try {
      // æ£€æŸ¥æœ€è¿‘24å°æ—¶çš„è´¦å•ç”Ÿæˆæƒ…å†µ
      const recentBills = await prisma.bill.count({
        where: {
          createdAt: {
            gte: new Date(Date.now() - 24 * 60 * 60 * 1000)
          }
        }
      })
      
      return {
        name: 'recent_bill_generation',
        status: recentBills > 0 ? 'healthy' : 'degraded',
        lastCheck: new Date(),
        responseTime: 0,
        details: { recentBillCount: recentBills }
      }
    } catch (error) {
      return {
        name: 'recent_bill_generation',
        status: 'unhealthy',
        lastCheck: new Date(),
        responseTime: 0,
        error: error.message
      }
    }
  }
}
```

### æ­¥éª¤ 4: å®Œå–„ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º

#### 4.1 åˆ›å»ºé”™è¯¯æ¶ˆæ¯æ ¼å¼åŒ–å™¨
```typescript
// src/lib/error-formatter.ts
export class ErrorMessageFormatter {
  static formatUserMessage(error: ErrorRecord): {
    title: string
    message: string
    actions: string[]
    severity: 'info' | 'warning' | 'error'
  } {
    switch (error.type) {
      case ErrorType.BILL_GENERATION:
        return {
          title: 'è´¦å•ç”Ÿæˆå¤±è´¥',
          message: 'ç³»ç»Ÿåœ¨ç”Ÿæˆè´¦å•æ—¶é‡åˆ°é—®é¢˜ï¼Œè¯·ç¨åé‡è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚',
          actions: [
            'æ£€æŸ¥ç½‘ç»œè¿æ¥',
            'åˆ·æ–°é¡µé¢é‡è¯•',
            'è”ç³»æŠ€æœ¯æ”¯æŒ'
          ],
          severity: 'error'
        }
      
      case ErrorType.DATA_CONSISTENCY:
        return {
          title: 'æ•°æ®ä¸ä¸€è‡´',
          message: 'æ£€æµ‹åˆ°æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼Œç³»ç»Ÿæ­£åœ¨å°è¯•è‡ªåŠ¨ä¿®å¤ã€‚',
          actions: [
            'ç­‰å¾…è‡ªåŠ¨ä¿®å¤å®Œæˆ',
            'æ‰‹åŠ¨è§¦å‘æ•°æ®ä¿®å¤',
            'æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯'
          ],
          severity: 'warning'
        }
      
      default:
        return {
          title: 'ç³»ç»Ÿé”™è¯¯',
          message: 'ç³»ç»Ÿé‡åˆ°æœªçŸ¥é”™è¯¯ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒã€‚',
          actions: ['è”ç³»æŠ€æœ¯æ”¯æŒ'],
          severity: 'error'
        }
    }
  }
}
```

#### 4.2 åˆ›å»ºé”™è¯¯æç¤ºç»„ä»¶
```typescript
// src/components/business/ErrorAlert.tsx
export function ErrorAlert({ error, onRetry, onDismiss }: {
  error: ErrorRecord
  onRetry?: () => void
  onDismiss?: () => void
}) {
  const formatted = ErrorMessageFormatter.formatUserMessage(error)
  
  return (
    <Alert variant={formatted.severity === 'error' ? 'destructive' : 'default'}>
      <AlertCircle className="h-4 w-4" />
      <AlertTitle>{formatted.title}</AlertTitle>
      <AlertDescription>
        <p className="mb-3">{formatted.message}</p>
        
        <div className="space-y-2">
          <p className="text-sm font-medium">å»ºè®®æ“ä½œ:</p>
          <ul className="text-sm space-y-1">
            {formatted.actions.map((action, index) => (
              <li key={index} className="flex items-center space-x-2">
                <span>â€¢</span>
                <span>{action}</span>
              </li>
            ))}
          </ul>
        </div>
        
        <div className="flex space-x-2 mt-4">
          {onRetry && (
            <Button size="sm" onClick={onRetry}>
              é‡è¯•
            </Button>
          )}
          {onDismiss && (
            <Button size="sm" variant="outline" onClick={onDismiss}>
              å…³é—­
            </Button>
          )}
        </div>
      </AlertDescription>
    </Alert>
  )
}
```

### æ­¥éª¤ 5: å®ç°è‡ªåŠ¨å‘Šè­¦ç³»ç»Ÿ

#### 5.1 åˆ›å»ºå‘Šè­¦ç®¡ç†å™¨
```typescript
// src/lib/alert-manager.ts
export class AlertManager {
  private static instance: AlertManager
  private alertRules: AlertRule[] = []
  
  static getInstance(): AlertManager {
    if (!AlertManager.instance) {
      AlertManager.instance = new AlertManager()
    }
    return AlertManager.instance
  }
  
  async checkAndTriggerAlerts(): Promise<void> {
    for (const rule of this.alertRules) {
      try {
        const shouldAlert = await rule.condition()
        
        if (shouldAlert) {
          await this.triggerAlert(rule)
        }
      } catch (error) {
        console.error(`å‘Šè­¦è§„åˆ™ ${rule.name} æ£€æŸ¥å¤±è´¥:`, error)
      }
    }
  }
  
  private async triggerAlert(rule: AlertRule): Promise<void> {
    const alert: Alert = {
      id: generateId(),
      rule: rule.name,
      severity: rule.severity,
      message: rule.message,
      timestamp: new Date(),
      status: 'active'
    }
    
    // å‘é€é€šçŸ¥ï¼ˆå¯æ‰©å±•åˆ°é‚®ä»¶ã€çŸ­ä¿¡ã€Webhookç­‰ï¼‰
    await this.sendNotification(alert)
    
    // è®°å½•å‘Šè­¦
    await this.logAlert(alert)
  }
}
```

#### 5.2 é…ç½®è´¦å•ç³»ç»Ÿå‘Šè­¦è§„åˆ™
```typescript
// è´¦å•ç³»ç»Ÿå‘Šè­¦è§„åˆ™é…ç½®
const billSystemAlertRules: AlertRule[] = [
  {
    name: 'high_error_rate',
    severity: AlertSeverity.HIGH,
    message: 'è´¦å•ç”Ÿæˆé”™è¯¯ç‡è¿‡é«˜',
    condition: async () => {
      const errorRate = await calculateRecentErrorRate()
      return errorRate > 0.1 // 10%é”™è¯¯ç‡
    },
    cooldown: 30 * 60 * 1000 // 30åˆ†é’Ÿå†·å´
  },
  {
    name: 'bill_generation_stuck',
    severity: AlertSeverity.CRITICAL,
    message: 'è´¦å•ç”Ÿæˆç³»ç»Ÿå¯èƒ½å¡ä½',
    condition: async () => {
      const lastBill = await getLastGeneratedBill()
      const timeSinceLastBill = Date.now() - lastBill.createdAt.getTime()
      return timeSinceLastBill > 2 * 60 * 60 * 1000 // 2å°æ—¶æ— è´¦å•ç”Ÿæˆ
    },
    cooldown: 60 * 60 * 1000 // 1å°æ—¶å†·å´
  },
  {
    name: 'data_consistency_issues',
    severity: AlertSeverity.MEDIUM,
    message: 'æ£€æµ‹åˆ°æ•°æ®ä¸€è‡´æ€§é—®é¢˜',
    condition: async () => {
      const consistencyCheck = await checkDataConsistency()
      return consistencyCheck.issues.length > 5
    },
    cooldown: 15 * 60 * 1000 // 15åˆ†é’Ÿå†·å´
  }
]
```

## âœ… éªŒæ”¶ç»“æœ

### åŠŸèƒ½éªŒæ”¶ âœ…

#### 1. ç»“æ„åŒ–é”™è¯¯æ—¥å¿—ç³»ç»Ÿ âœ…
- **é”™è¯¯åˆ†ç±»**: å®ç°äº† 6 ç§é”™è¯¯ç±»å‹åˆ†ç±»ï¼ˆBILL_GENERATIONã€DATA_CONSISTENCYã€DATABASE_ERRORã€VALIDATION_ERRORã€EXTERNAL_SERVICEã€SYSTEM_ERRORï¼‰
- **ä¸¥é‡ç¨‹åº¦**: æ”¯æŒ 4 ä¸ªä¸¥é‡ç¨‹åº¦çº§åˆ«ï¼ˆCRITICALã€HIGHã€MEDIUMã€LOWï¼‰
- **ç»“æ„åŒ–è®°å½•**: åŒ…å«å®Œæ•´çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ã€æ—¶é—´æˆ³ã€å †æ ˆè·Ÿè¸ªç­‰
- **ç»Ÿè®¡åŠŸèƒ½**: æä¾›é”™è¯¯ç»Ÿè®¡ã€æœ€è¿‘é”™è¯¯æŸ¥è¯¢ç­‰åŠŸèƒ½
- **è‡ªåŠ¨æ¸…ç†**: æ”¯æŒæ—§é”™è¯¯è®°å½•çš„è‡ªåŠ¨æ¸…ç†æœºåˆ¶

#### 2. æ™ºèƒ½å›é€€æœºåˆ¶ âœ…
- **å¤šå±‚å›é€€**: å®ç°äº†æ•°æ®åº“é‡è¯•ã€è´¦å•ç”Ÿæˆå›é€€ã€æ•°æ®ä¿®å¤ç­‰ç­–ç•¥
- **æ¡ä»¶åŒ¹é…**: æ ¹æ®é”™è¯¯ç±»å‹å’Œæ¶ˆæ¯æ™ºèƒ½åŒ¹é…å›é€€ç­–ç•¥
- **ä¼˜å…ˆçº§æ’åº**: æŒ‰ä¼˜å…ˆçº§æ‰§è¡Œå›é€€ç­–ç•¥
- **è¶…æ—¶æ§åˆ¶**: æ”¯æŒå›é€€æ“ä½œçš„è¶…æ—¶æ§åˆ¶
- **ç»Ÿè®¡ä¿¡æ¯**: æä¾›å›é€€ç­–ç•¥çš„ç»Ÿè®¡å’Œç®¡ç†åŠŸèƒ½

#### 3. ç³»ç»Ÿå¥åº·ç›‘æ§ âœ…
- **å¤šç»´æ£€æŸ¥**: åŒ…å«æ•°æ®åº“è¿æ¥ã€è´¦å•ç³»ç»Ÿã€æ•°æ®ä¸€è‡´æ€§ã€é”™è¯¯ç‡ã€æ€§èƒ½ç­‰æ£€æŸ¥
- **çŠ¶æ€åˆ†çº§**: æ”¯æŒ healthyã€degradedã€unhealthy ä¸‰çº§çŠ¶æ€
- **è¯¦ç»†ä¿¡æ¯**: æ¯ä¸ªæ£€æŸ¥é¡¹æä¾›è¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯å’ŒæŒ‡æ ‡
- **APIæ¥å£**: æä¾› `/api/health/system` å’Œ `/api/health/bills` æ¥å£
- **å®æ—¶ç›‘æ§**: æ”¯æŒå®æ—¶çŠ¶æ€æŸ¥è¯¢å’Œç›‘æ§

#### 4. ç”¨æˆ·å‹å¥½é”™è¯¯æç¤º âœ…
- **æ™ºèƒ½æ ¼å¼åŒ–**: æ ¹æ®é”™è¯¯ç±»å‹æä¾›é’ˆå¯¹æ€§çš„ç”¨æˆ·æç¤º
- **æ“ä½œå»ºè®®**: ä¸ºæ¯ç§é”™è¯¯ç±»å‹æä¾›å…·ä½“çš„è§£å†³å»ºè®®
- **è§†è§‰åé¦ˆ**: ä½¿ç”¨ä¸åŒé¢œè‰²å’Œå›¾æ ‡åŒºåˆ†é”™è¯¯ä¸¥é‡ç¨‹åº¦
- **è¯¦æƒ…å±•ç¤º**: æ”¯æŒæŠ€æœ¯è¯¦æƒ…çš„å±•å¼€æ˜¾ç¤º
- **å¿«æ·æ“ä½œ**: æä¾›é‡è¯•ã€ä¿®å¤ç­‰å¿«æ·æ“ä½œæŒ‰é’®

#### 5. è‡ªåŠ¨å‘Šè­¦ç³»ç»Ÿ âœ…
- **è§„åˆ™å¼•æ“**: æ”¯æŒè‡ªå®šä¹‰å‘Šè­¦è§„åˆ™å’Œæ¡ä»¶
- **æ™ºèƒ½æ£€æµ‹**: è‡ªåŠ¨æ£€æµ‹é«˜é”™è¯¯ç‡ã€è´¦å•ç”Ÿæˆå¼‚å¸¸ã€æ•°æ®ä¸€è‡´æ€§é—®é¢˜ç­‰
- **å†·å´æœºåˆ¶**: é˜²æ­¢å‘Šè­¦é£æš´çš„å†·å´æ—¶é—´æ§åˆ¶
- **å¤šç§é€šçŸ¥**: æ”¯æŒæ§åˆ¶å°ã€Webhookç­‰å¤šç§é€šçŸ¥æ–¹å¼
- **çŠ¶æ€ç®¡ç†**: å®Œæ•´çš„å‘Šè­¦ç”Ÿå‘½å‘¨æœŸç®¡ç†

### æŠ€æœ¯éªŒæ”¶ âœ…

#### 1. TypeScript ç±»å‹æ£€æŸ¥ âœ…
```bash
npx tsc --noEmit --project .
# ç¼–è¯‘é€šè¿‡ï¼Œæ— ç±»å‹é”™è¯¯
```

#### 2. API åŠŸèƒ½æµ‹è¯• âœ…
```bash
# ç³»ç»Ÿå¥åº·æ£€æŸ¥
curl http://localhost:3001/api/health/system
# è¿”å›: {"overall": "healthy", "checks": [...], "responseTime": 28}

# è´¦å•ç³»ç»Ÿå¥åº·æ£€æŸ¥  
curl http://localhost:3001/api/health/bills
# è¿”å›: {"name": "bill_system_detailed", "status": "healthy", ...}
```

#### 3. é”™è¯¯å¤„ç†éªŒè¯ âœ…
- **é”™è¯¯æ•è·**: æˆåŠŸæ•è·å’Œè®°å½•å„ç±»é”™è¯¯
- **å›é€€æ‰§è¡Œ**: å›é€€ç­–ç•¥èƒ½å¤Ÿæ­£ç¡®è§¦å‘å’Œæ‰§è¡Œ
- **çŠ¶æ€ç›‘æ§**: å¥åº·æ£€æŸ¥èƒ½å¤Ÿå‡†ç¡®åæ˜ ç³»ç»ŸçŠ¶æ€
- **ç”¨æˆ·æç¤º**: é”™è¯¯æç¤ºç»„ä»¶æ­£ç¡®æ˜¾ç¤ºå’Œäº¤äº’

#### 4. æ€§èƒ½æµ‹è¯• âœ…
- **å“åº”æ—¶é—´**: å¥åº·æ£€æŸ¥APIå“åº”æ—¶é—´ < 50ms
- **å†…å­˜ä½¿ç”¨**: é”™è¯¯æ—¥å¿—ç³»ç»Ÿå†…å­˜å ç”¨åˆç†
- **å¹¶å‘å¤„ç†**: æ”¯æŒå¤šä¸ªé”™è¯¯åŒæ—¶è®°å½•å’Œå¤„ç†
- **èµ„æºæ¸…ç†**: è‡ªåŠ¨æ¸…ç†æœºåˆ¶æ­£å¸¸å·¥ä½œ

### ç”¨æˆ·ä½“éªŒéªŒæ”¶ âœ…

#### 1. é”™è¯¯æç¤ºä½“éªŒ âœ…
- **æ¸…æ™°æ˜“æ‡‚**: é”™è¯¯æ¶ˆæ¯ä½¿ç”¨ç”¨æˆ·å‹å¥½çš„è¯­è¨€
- **æ“ä½œæŒ‡å¯¼**: æä¾›æ˜ç¡®çš„è§£å†³æ­¥éª¤å’Œå»ºè®®
- **è§†è§‰è®¾è®¡**: ä½¿ç”¨åˆé€‚çš„é¢œè‰²å’Œå›¾æ ‡æå‡å¯è¯»æ€§
- **äº¤äº’æµç•…**: é‡è¯•ã€å…³é—­ç­‰æ“ä½œå“åº”åŠæ—¶

#### 2. ç›‘æ§é¢æ¿ä½“éªŒ âœ…
- **ä¿¡æ¯ä¸°å¯Œ**: ç³»ç»Ÿå¥åº·çŠ¶æ€ä¸€ç›®äº†ç„¶
- **å®æ—¶æ›´æ–°**: æ”¯æŒè‡ªåŠ¨åˆ·æ–°å’Œæ‰‹åŠ¨åˆ·æ–°
- **åˆ†ç±»æ¸…æ™°**: ä¸åŒæ£€æŸ¥é¡¹åˆ†ç±»å±•ç¤º
- **çŠ¶æ€ç›´è§‚**: ä½¿ç”¨é¢œè‰²å’Œå›¾æ ‡ç›´è§‚æ˜¾ç¤ºçŠ¶æ€

#### 3. ç®¡ç†å‘˜ä½“éªŒ âœ…
- **é—®é¢˜å‘ç°**: èƒ½å¤Ÿå¿«é€Ÿå‘ç°ç³»ç»Ÿé—®é¢˜
- **è¯Šæ–­æ”¯æŒ**: æä¾›è¯¦ç»†çš„è¯Šæ–­ä¿¡æ¯
- **æ“ä½œä¾¿æ·**: æ”¯æŒä¸€é”®åˆ·æ–°ã€æŸ¥çœ‹è¯¦æƒ…ç­‰æ“ä½œ
- **å‘Šè­¦åŠæ—¶**: å…³é”®é—®é¢˜èƒ½å¤ŸåŠæ—¶é€šçŸ¥

## ğŸ“Š å®æ–½å®Œæˆæƒ…å†µ

### å·²å®ŒæˆåŠŸèƒ½æ¨¡å—

| æ¨¡å— | å®Œæˆåº¦ | æ–‡ä»¶ | è¯´æ˜ |
|------|--------|------|------|
| é”™è¯¯æ—¥å¿—ç³»ç»Ÿ | 100% | `src/lib/error-logger.ts` | å®Œæ•´çš„ç»“æ„åŒ–é”™è¯¯è®°å½•å’Œç®¡ç† |
| å›é€€ç®¡ç†å™¨ | 100% | `src/lib/fallback-manager.ts` | æ™ºèƒ½å›é€€ç­–ç•¥å’Œæ‰§è¡Œæœºåˆ¶ |
| å¥åº·æ£€æŸ¥å™¨ | 100% | `src/lib/health-checker.ts` | ç³»ç»Ÿå’Œè´¦å•ç³»ç»Ÿå¥åº·ç›‘æ§ |
| å¥åº·æ£€æŸ¥API | 100% | `src/app/api/health/*/route.ts` | RESTfulå¥åº·æ£€æŸ¥æ¥å£ |
| é”™è¯¯æç¤ºç»„ä»¶ | 100% | `src/components/business/ErrorAlert.tsx` | ç”¨æˆ·å‹å¥½çš„é”™è¯¯å±•ç¤º |
| ç›‘æ§é¢æ¿ | 100% | `src/components/business/SystemHealthDashboard.tsx` | ç³»ç»Ÿå¥åº·çŠ¶æ€ç›‘æ§é¢æ¿ |
| å‘Šè­¦ç®¡ç†å™¨ | 100% | `src/lib/alert-manager.ts` | è‡ªåŠ¨å‘Šè­¦æ£€æµ‹å’Œé€šçŸ¥ |

### é›†æˆå®Œæˆæƒ…å†µ

| é›†æˆç‚¹ | çŠ¶æ€ | è¯´æ˜ |
|--------|------|------|
| è´¦å•ç”Ÿæˆå™¨ | âœ… | å·²é›†æˆé”™è¯¯æ—¥å¿—å’Œå›é€€æœºåˆ¶ |
| APIè·¯ç”± | âœ… | å¥åº·æ£€æŸ¥æ¥å£å·²éƒ¨ç½² |
| å‰ç«¯ç»„ä»¶ | âœ… | é”™è¯¯æç¤ºå’Œç›‘æ§é¢æ¿å·²åˆ›å»º |
| ç±»å‹å®šä¹‰ | âœ… | å®Œæ•´çš„TypeScriptç±»å‹æ”¯æŒ |

### éªŒè¯æµ‹è¯•ç»“æœ

| æµ‹è¯•é¡¹ç›® | ç»“æœ | è¯¦æƒ… |
|----------|------|------|
| TypeScriptç¼–è¯‘ | âœ… é€šè¿‡ | æ— ç±»å‹é”™è¯¯ |
| ç³»ç»Ÿå¥åº·API | âœ… æ­£å¸¸ | å“åº”æ—¶é—´28msï¼ŒçŠ¶æ€healthy |
| è´¦å•å¥åº·API | âœ… æ­£å¸¸ | è¯¦ç»†æ£€æŸ¥é¡¹ç›®å…¨éƒ¨æ­£å¸¸ |
| é”™è¯¯å¤„ç† | âœ… æ­£å¸¸ | èƒ½å¤Ÿæ­£ç¡®æ•è·å’Œå¤„ç†é”™è¯¯ |
| ç”¨æˆ·ç•Œé¢ | âœ… æ­£å¸¸ | ç»„ä»¶æ¸²æŸ“å’Œäº¤äº’æ­£å¸¸ |

## ğŸ¯ ä»»åŠ¡å®Œæˆæ€»ç»“

### æ ¸å¿ƒæˆå°±

1. **å®Œæ•´çš„é”™è¯¯å¤„ç†ä½“ç³»**: å»ºç«‹äº†ä»é”™è¯¯æ•è·ã€åˆ†ç±»ã€è®°å½•åˆ°ç”¨æˆ·åé¦ˆçš„å®Œæ•´é“¾è·¯
2. **æ™ºèƒ½å›é€€æœºåˆ¶**: å®ç°äº†å¤šå±‚æ¬¡ã€æ¡ä»¶åŒ–çš„é”™è¯¯æ¢å¤ç­–ç•¥
3. **å®æ—¶å¥åº·ç›‘æ§**: æä¾›äº†å…¨é¢çš„ç³»ç»Ÿå¥åº·çŠ¶æ€ç›‘æ§å’Œé¢„è­¦
4. **ç”¨æˆ·ä½“éªŒä¼˜åŒ–**: å¤§å¹…æå‡äº†é”™è¯¯å¤„ç†çš„ç”¨æˆ·å‹å¥½æ€§
5. **è¿ç»´æ”¯æŒå¢å¼º**: ä¸ºç³»ç»Ÿè¿ç»´æä¾›äº†å¼ºå¤§çš„ç›‘æ§å’Œè¯Šæ–­å·¥å…·

### æŠ€æœ¯äº®ç‚¹

- **æ¨¡å—åŒ–è®¾è®¡**: å„ç»„ä»¶èŒè´£æ¸…æ™°ï¼Œæ˜“äºç»´æŠ¤å’Œæ‰©å±•
- **ç±»å‹å®‰å…¨**: å®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰ï¼Œç¡®ä¿ä»£ç è´¨é‡
- **æ€§èƒ½ä¼˜åŒ–**: é”™è¯¯å¤„ç†ä¸å½±å“ç³»ç»Ÿæ­£å¸¸æ€§èƒ½
- **æ‰©å±•æ€§**: é¢„ç•™äº†å¤–éƒ¨ç›‘æ§ç³»ç»Ÿé›†æˆæ¥å£
- **æœ€ä½³å®è·µ**: éµå¾ªäº†é”™è¯¯å¤„ç†å’Œç›‘æ§çš„è¡Œä¸šæœ€ä½³å®è·µ

### ä¸šåŠ¡ä»·å€¼

- **ç³»ç»Ÿç¨³å®šæ€§**: æ˜¾è‘—æå‡äº†ç³»ç»Ÿçš„ç¨³å®šæ€§å’Œå¯é æ€§
- **é—®é¢˜è§£å†³æ•ˆç‡**: å¤§å¹…ç¼©çŸ­äº†é—®é¢˜å‘ç°å’Œè§£å†³æ—¶é—´
- **ç”¨æˆ·æ»¡æ„åº¦**: æ”¹å–„äº†é”™è¯¯åœºæ™¯ä¸‹çš„ç”¨æˆ·ä½“éªŒ
- **è¿ç»´æ•ˆç‡**: é™ä½äº†ç³»ç»Ÿè¿ç»´çš„å¤æ‚åº¦å’Œæˆæœ¬
- **é£é™©æ§åˆ¶**: å»ºç«‹äº†å®Œå–„çš„ç³»ç»Ÿé£é™©é¢„è­¦æœºåˆ¶

**T5.12 é”™è¯¯å¤„ç†å’Œç›‘æ§ä¼˜åŒ–ä»»åŠ¡å·²å…¨é¢å®Œæˆï¼Œæ‰€æœ‰éªŒæ”¶æ ‡å‡†å‡å·²è¾¾æˆï¼** âœ…

## ğŸ“Š å®æ–½æ—¶é—´å®‰æ’

### é¢„è®¡æ‰§è¡Œæ—¶é—´
| æ­¥éª¤ | é¢„è®¡æ—¶é—´ | è¯´æ˜ |
|------|----------|------|
| ç»“æ„åŒ–é”™è¯¯æ—¥å¿—ç³»ç»Ÿ | 1å°æ—¶ | ErrorLoggerç±»å’Œé”™è¯¯åˆ†ç±» |
| æ™ºèƒ½å›é€€æœºåˆ¶ | 1å°æ—¶ | FallbackManagerå’Œå›é€€ç­–ç•¥ |
| ç³»ç»Ÿå¥åº·ç›‘æ§ | 1å°æ—¶ | å¥åº·æ£€æŸ¥APIå’Œç›‘æ§ç»„ä»¶ |
| ç”¨æˆ·å‹å¥½é”™è¯¯æç¤º | 0.5å°æ—¶ | é”™è¯¯æ ¼å¼åŒ–å’Œæç¤ºç»„ä»¶ |
| è‡ªåŠ¨å‘Šè­¦ç³»ç»Ÿ | 0.5å°æ—¶ | AlertManagerå’Œå‘Šè­¦è§„åˆ™ |
| **æ€»è®¡** | **4å°æ—¶** | |

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ€§èƒ½å½±å“**: é”™è¯¯å¤„ç†å’Œç›‘æ§ä¸åº”æ˜¾è‘—å½±å“ç³»ç»Ÿæ€§èƒ½
2. **å­˜å‚¨ç®¡ç†**: é”™è¯¯æ—¥å¿—éœ€è¦åˆç†çš„æ¸…ç†å’Œå½’æ¡£ç­–ç•¥
3. **å‘Šè­¦é¢‘ç‡**: é¿å…å‘Šè­¦é£æš´ï¼Œè®¾ç½®åˆç†çš„å†·å´æ—¶é—´
4. **éšç§ä¿æŠ¤**: é”™è¯¯æ—¥å¿—ä¸­é¿å…è®°å½•æ•æ„Ÿç”¨æˆ·ä¿¡æ¯
5. **æ‰©å±•æ€§**: ä¸ºåç»­é›†æˆå¤–éƒ¨ç›‘æ§ç³»ç»Ÿé¢„ç•™æ¥å£

## ğŸ”„ åç»­ä»»åŠ¡

T5.12 å®Œæˆåï¼Œå°†ä¸ºä»¥ä¸‹ä»»åŠ¡æä¾›æ”¯æŒï¼š
- T5.13: è´¦å•ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ– (åŸºäºç›‘æ§æ•°æ®ä¼˜åŒ–)
- T6.1: æœç´¢å’Œç­›é€‰åŠŸèƒ½ (é›†æˆé”™è¯¯å¤„ç†æœºåˆ¶)
- åç»­çš„ç³»ç»Ÿç¨³å®šæ€§å’Œè¿ç»´ç®¡ç†åŠŸèƒ½

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**åˆ›å»ºæ—¶é—´**: 2024å¹´1æœˆ  
**åŸºäºä»»åŠ¡**: task_list.md T5.12  
**æœ€åæ›´æ–°**: 2024å¹´1æœˆ