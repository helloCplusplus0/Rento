# 合同编辑策略设计文档 v2.0

## 📋 业务背景

基于实际公寓管理经验和用户反思，合同作为法律文件具有以下特点：
- **完整性**：合同是一个整体性的、一段时期性的协议
- **稳定性**：签订后不易轻易改变，特别是费用条款和支付条款
- **信任基础**：租客非常忌讳不按合同执行，中途变更费用

## 🎯 设计原则 v2.0

### 1. 合同核心条款不可变原则
- **生效中的合同**：不允许修改任何核心条款（费用信息、支付信息、合同期限）
- **理由**：保护租客权益，维护合同的法律效力和双方信任

### 2. 签约信息可编辑原则
- **允许编辑**：签约人、签约日期等签约相关信息
- **理由**：这些信息不影响合同核心条款，主要用于记录和管理

### 3. 额外费用独立处理原则
- **合同外费用**：通过"创建账单"功能单独处理
- **示例**：临时维修费、违约金、额外服务费等

## 🔧 技术实现 v2.0

### 合同状态分类编辑权限

| 合同状态 | 费用信息 | 支付信息 | 签约信息 | 合同条款 | 说明 |
|----------|----------|----------|----------|----------|------|
| PENDING（待生效） | ✅ 可编辑 | ✅ 可编辑 | ✅ 可编辑 | ✅ 可编辑 | 合同未生效，允许全面修改 |
| ACTIVE（生效中） | ❌ 不可编辑 | ❌ 不可编辑 | ✅ 可编辑 | ❌ 不可编辑 | 只允许编辑签约信息 |
| EXPIRED（已到期） | ❌ 不可编辑 | ❌ 不可编辑 | ✅ 可编辑 | ❌ 不可编辑 | 历史记录，仅允许签约信息更新 |
| TERMINATED（已终止） | ❌ 不可编辑 | ❌ 不可编辑 | ✅ 可编辑 | ❌ 不可编辑 | 历史记录，仅允许签约信息更新 |

### 字段分类 v2.0

#### 费用信息（生效后不可编辑）
- `monthlyRent` - 月租金
- `deposit` - 押金
- `keyDeposit` - 钥匙押金
- `cleaningFee` - 清洁费
- `totalRent` - 总租金（自动计算）

#### 支付信息（生效后不可编辑）
- `paymentMethod` - 付款方式（月付/季付/年付）
- `paymentTiming` - 收租时间规则

#### 签约信息（始终可编辑）
- `signedBy` - 签约人
- `signedDate` - 签约时间

#### 合同条款（生效后不可编辑）
- `startDate` - 开始日期
- `endDate` - 结束日期
- `renterId` - 租客ID
- `roomId` - 房间ID

## 💡 业务流程 v2.0

### 费用调整场景处理

#### 1. 合同期内额外费用
```
场景：租客损坏设施需要赔偿
处理：创建"其他"类型账单
优势：不影响原合同，记录清晰
```

#### 2. 租金调整需求
```
场景：市场价格变化，需要调整租金
处理：等待合同到期，重新签约
流程：
  1. 合同到期前30天协商
  2. 双方同意 → 签订新合同
  3. 双方不同意 → 租客退租
```

#### 3. 支付方式调整需求
```
场景：租客希望改变支付周期
处理：等待合同到期，重新签约
说明：支付方式影响账单生成，不可中途变更
```

## 🔒 系统保护机制 v2.0

### 前端保护
- 编辑模式下禁用费用和支付字段输入
- 显示明确的提示信息
- 引导用户使用正确的处理方式
- 专用的简化编辑页面，不复用添加合同逻辑

### 后端保护
- API层面检查合同状态
- 生效中的合同拒绝费用和支付信息修改请求
- 返回明确的错误信息

### 架构保护
- 编辑页面独立实现，不复用添加合同的逻辑
- 避免意外触发账单生成等添加合同的副作用
- 确保编辑操作的安全性和可控性

## 📊 优势分析 v2.0

### 1. 法律合规性
- 保护合同的法律效力
- 避免合同纠纷
- 维护双方权益

### 2. 用户信任度
- 租客信任系统按合同执行
- 房东操作规范透明
- 减少沟通成本

### 3. 数据一致性
- 避免费用变更导致的账单混乱
- 保持历史数据的准确性
- 简化系统逻辑

### 4. 管理效率
- 明确的操作边界
- 减少错误操作
- 提高管理规范性

### 5. 系统安全性
- 独立的编辑逻辑，避免意外副作用
- 不会触发账单生成等添加合同的功能
- 确保编辑操作的可控性

## 🔄 替代方案

### 合同续约功能
- 到期前启动续约流程
- 可以调整所有条款
- 生成新的合同记录
- 保持历史记录完整

### 账单管理功能
- 处理合同外的临时费用
- 灵活的费用类型支持
- 独立的收费记录
- 不影响原合同条款

## 🏗️ 技术架构 v2.0

### 编辑页面架构
```
EditContractPageSimple (专用编辑页面)
├── 合同信息展示 (只读)
├── 编辑说明 (用户引导)
├── 签约信息编辑 (可编辑)
└── 操作按钮 (保存/取消)
```

### API权限控制
```typescript
// 生效中的合同只允许编辑签约信息
if (contract.status === 'ACTIVE') {
  allowedFields = ['signedBy', 'signedDate']
} else {
  allowedFields = ['all'] // 待生效合同允许编辑所有字段
}
```

## 📝 总结 v2.0

这种设计完全符合实际公寓管理的业务需求和用户反思：
- **保护合同完整性**：生效后的合同核心条款不可变更
- **提供必要灵活性**：允许编辑签约信息
- **支持业务扩展**：通过账单系统处理额外费用
- **引导正确流程**：推荐续约而非中途变更
- **确保系统安全**：独立的编辑逻辑，避免意外副作用

通过这种设计，系统既保证了合同的法律效力和双方信任，又提供了安全可控的编辑功能，避免了复用添加合同逻辑可能带来的风险。
| EXPIRED（已到期） | ❌ 不可编辑 | ✅ 可编辑 | ❌ 不可编辑 | 历史记录，仅允许管理信息更新 |
| TERMINATED（已终止） | ❌ 不可编辑 | ✅ 可编辑 | ❌ 不可编辑 | 历史记录，仅允许管理信息更新 |

### 字段分类

#### 费用信息（生效后不可编辑）
- `monthlyRent` - 月租金
- `deposit` - 押金
- `keyDeposit` - 钥匙押金
- `cleaningFee` - 清洁费
- `totalRent` - 总租金（自动计算）

#### 管理信息（始终可编辑）
- `paymentMethod` - 付款方式描述
- `paymentTiming` - 收租时间规则
- `signedBy` - 签约人
- `signedDate` - 签约时间

#### 合同条款（生效后不可编辑）
- `startDate` - 开始日期
- `endDate` - 结束日期
- `renterId` - 租客ID
- `roomId` - 房间ID

## 💡 业务流程

### 费用调整场景处理

#### 1. 合同期内额外费用
```
场景：租客损坏设施需要赔偿
处理：创建"其他"类型账单
优势：不影响原合同，记录清晰
```

#### 2. 租金调整需求
```
场景：市场价格变化，需要调整租金
处理：等待合同到期，重新签约
流程：
  1. 合同到期前30天协商
  2. 双方同意 → 签订新合同
  3. 双方不同意 → 租客退租
```

#### 3. 押金调整
```
场景：需要增加押金保障
处理：创建"押金"类型补充账单
说明：原押金不变，新增部分单独记录
```

## 🔒 系统保护机制

### 前端保护
- 编辑模式下禁用费用字段输入
- 显示明确的提示信息
- 引导用户使用正确的处理方式

### 后端保护
- API层面检查合同状态
- 生效中的合同拒绝费用修改请求
- 返回明确的错误信息

### 用户引导
- 提供清晰的操作指引
- 推荐正确的业务流程
- 避免用户产生困惑

## 📊 优势分析

### 1. 法律合规性
- 保护合同的法律效力
- 避免合同纠纷
- 维护双方权益

### 2. 用户信任度
- 租客信任系统按合同执行
- 房东操作规范透明
- 减少沟通成本

### 3. 数据一致性
- 避免费用变更导致的账单混乱
- 保持历史数据的准确性
- 简化系统逻辑

### 4. 管理效率
- 明确的操作边界
- 减少错误操作
- 提高管理规范性

## 🔄 替代方案

### 合同续约功能
- 到期前启动续约流程
- 可以调整所有条款
- 生成新的合同记录
- 保持历史记录完整

### 账单管理功能
- 处理合同外的临时费用
- 灵活的费用类型支持
- 独立的收费记录
- 不影响原合同条款

## 📝 总结

这种设计完全符合实际公寓管理的业务需求：
- **保护合同完整性**：生效后的合同费用不可变更
- **提供管理灵活性**：允许编辑管理信息
- **支持业务扩展**：通过账单系统处理额外费用
- **引导正确流程**：推荐续约而非中途变更

通过这种设计，系统既保证了合同的法律效力和双方信任，又提供了足够的管理灵活性来处理各种实际业务场景。